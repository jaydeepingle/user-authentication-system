<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Web Client</title>
        <link rel="stylesheet" href="style.css">
        <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    </head>
    <body>
        <div id="root"></div>
        <script type="text/babel">
              (function() {

                const WS_URL = 'http://localhost:1234';
                const EMAIL = 'email';
                const AUTHTOKEN = 'authToken';

                //app, login, account, registration
                //classes

                function UserService() {

                    function getWsUrl() {
                        const params = (new URL(document.location)).searchParams;
                        return params.get('ws-url') || WS_URL;
                    }

                    this.baseUrl = getWsUrl();

                    //All action functions return promises.

                    this.register = function(id, pw, info) {
                        return axios.put(`${this.baseUrl}/users/${id}?pw=${pw}`,
                                info, {
                                    maxRedirects: 0
                                })
                            .then((response) => response.data)
                            .catch(function(err) {
                                const status = err.response.status;
                                if (status === 303) {
                                    return err.response.data;
                                } else {
                                    throw err;
                                }
                            });
                    }

                    this.login = function(id, pw) {
                        return axios.put(`${this.baseUrl}/users/${id}/auth`, {
                                pw: pw
                            }, {
                                maxRedirects: 0
                            })
                            .then((response) => response.data)
                            .catch(function(err) {
                                const status = err.response.status;
                                if (status === 401 || status === 404) {
                                    return err.response.data;
                                } else {
                                    throw err;
                                }
                            });
                    }

                    this.info = function(id, authToken) {
                        return axios.request({
                                url: `${this.baseUrl}/users/${id}`,
                                method: 'get',
                                headers: {
                                    Authorization: `Bearer ${authToken}`
                                }
                            })
                            .then((response) => response.data)
                            .catch(function(err) {
                                const status = err.response.status;
                                if (status === 401 || status === 404) {
                                    return err.response.data;
                                } else {
                                    throw err;
                                }
                            });

                    }
                }

                // class Login extends React.Component {
                //     constructor(props) {
                //         super(props);
                //         this.clickHandler = this.clickHandler.bind(this);
                //     }
                // }

                // class Register extends React.Component {
                //     constructor(props) {
                //         super(props);
                //         this.clickHandler = this.clickHandler.bind(this);
                //     }
                // }

                class Account extends React.Component {
                    constructor(props) {
                        super(props);
                        this.clickHandler = this.clickHandler.bind(this);
                    }
                }

                // function Results
                function Results(props) {
                    // const results = props.results.map(function(r) {
                    //     return <BookResult key={r._id} book={r} app={props.app}/>
                    // });
                    return (
                        <div>
                            <h1>Book Search Results</h1>
                            // {results}
                        </div>
                    );
                } // function Results end

                // class Cart
                class Register extends React.Component {
                    constructor(props) {
                        console.log("Register Class");
                        super(props);
                        this.app = props.app;
                        this.state = {
                            //items: [],
                            email: '',
                            password: '',
                            firstname: '',
                            lastname: '',
                            confirmPassword: ''
                        };
                        this.qHandler = this.qHandler.bind(this);
                        this.submitHandler = this.submitHandler.bind(this);
                    }

                    qHandler(event) {
                        // const q = event.target.value;
                        // this.searchIsOk(q);
                        this.setState({q: q, genError: ''});
                    }

                    submitHandler(event) {
                        // const q = this.state.q;
                        // const email = this.state.email;
                        // const self = this;
                        // if (this.searchIsOk(email)) {
                        //     this.app.ws.search(email).
                  	    //      then(function(results) {
                  	    //           if (results.length == 0) {
                  	    //                self.setState({genError: 'no results'});
                  	    //           } else {
              	        //                self.app.setActive(<Results results={results} app={self.app}/>);
                  	    //           }
                  	    //      }).
                  	    //      catch((err) => alert(err));
                        // }
                        // event.preventDefault();
                    }

                    componentDidMount() {
                        const self = this;
                        // cartIdPromise(self.app.ws).
                        // then((cartId) => self.app.ws.getCart(cartId)).
                        //then((items) => self.setState({items: items}));
                    }

                    render() {
                        const self = this;
                        // const email = this.state.email;
                        // const password = this.state.password;
                        const {email, password, firstname, lastname, confirmPassword, q, qError, genError} = this.state;
                        const {qHandler, submitHandler, qEmailError, qFirstNameError, qLastNameError, qPasswordError, qConfirmPasswordError} = this;
                        // if (this.state.items.length === 0) {
                        //     return <p>Register is empty</p>;
                        // } else {

                            // const items = this.state.items.map(function(item) {
                            //     return <CartItem key={item._itemId} item={item} app={self.app}/>
                            // });
                            return (
                                <div>
                                    <h1>Register</h1>
                                    <label>
                                    <span className="label">Email</span>
                                    <input name="email" className="control" value={email} onBlur={qHandler} onChange={qHandler} /> <br/>
                                    <span className="error">{qEmailError}<br/></span>
                                    </label>

                                    <label>
                                    <span className="label">First Name</span>
                                    <input name="firstname" className="control" value={firstname} onBlur={qHandler} onChange={qHandler} /> <br/>
                                    <span className="error">{qFirstNameError}<br/></span>
                                    </label>

                                    <label>
                                    <span className="label">Last Name</span>
                                    <input name="lastname" className="control" value={lastname} onBlur={qHandler} onChange={qHandler} /> <br/>
                                    <span className="error">{qLastNameError}<br/></span>
                                    </label>

                                    <label>
                                    <span className="label">Password</span>
                                    <input name="password" className="control" value={password} onBlur={qHandler} onChange={qHandler} /> <br/>
                                    <span className="error">{qPasswordError}<br/></span>
                                    </label>

                                    <label>
                                    <span className="label">Confirm Password</span>
                                    <input name="confirmPassword" className="control" value={confirmPassword} onBlur={qHandler} onChange={qHandler} /> <br/>
                                    <span className="error">{qConfirmPasswordError}<br/></span>
                                    </label>

                                    <input name="submit" type="submit" value="Register" className="control"/>

                                </div>
                            );
                        //}
                    }
                } // class Cart ends

                //{items}

                // class Login
                class Login extends React.Component {
                    constructor(props) {
                        console.log("Login Class");
                        super(props);
                        this.app = props.app;
                        this.state = {
                            email: '',
                            password: '',
                            q: '',
                            qError: '',
                            genError: '',
                        };
                        this.qHandler = this.qHandler.bind(this);
                        this.submitHandler = this.submitHandler.bind(this);
                    }

                    searchIsOk(q) {
                        const err = (q.trim().length === 0) ? 'login cannot be empty' : '';
                        this.setState({qError: err});
                        return err.length === 0;
                    }

                    qHandler(event) {
                        const q = event.target.value;
                        this.searchIsOk(q);
                        this.setState({q: q, genError: ''});
                    }

                    submitHandler(event) {
                        const q = this.state.q;
                        const email = this.state.email;
                        const self = this;
                        if (this.searchIsOk(email)) {
                            this.app.ws.search(email).
                  	         then(function(results) {
                  	              if (results.length == 0) {
                  	                   self.setState({genError: 'no results'});
                  	              } else {
              	                       self.app.setActive(<Results results={results} app={self.app}/>);
                  	              }
                  	         }).
                  	         catch((err) => alert(err));
                        }
                        event.preventDefault();
                    }

                    render() {
                        const {email, password, q, qError, genError} = this.state;
                        const {qHandler, submitHandler} = this;
                        return (
                            <div>
                  	             <h1>Login</h1>
              	                 <p className="error">{genError}</p>
              	                 <form onSubmit={submitHandler}>
                                     <label>
                      	             <span className="label">Username</span>
                      	             <input name="email" className="control" value={email} onBlur={qHandler} onChange={qHandler} /> <br/>
                      	             <span className="error">{qError}<br/></span>
                                     </label>

                                     <label>
                      	             <span className="label">Password</span>
                      	             <input name="password" className="control" value={password} onBlur={qHandler} onChange={qHandler} /> <br/>
                      	             <span className="error">{qError}<br/></span>
                                     </label>

                                     <input name="submit" type="submit" value="Login" className="control"/>
                  	             </form>
                  	        </div>
                        );
                    }
                } // class Search end



                // class App
                class App extends React.Component {
                    constructor(props) {
                        console.log("App Class");
                        super(props);
                        this.ws = props.ws;
                        this.state = { active: <Login app={this}/> }
                        this.clickHandler = this.clickHandler.bind(this);
                    }

                    setActive(component) {
                        this.setState({
                            active: component
                        });
                    }

                    clickHandler(event) {
                        const id = event.target.id;
                        const component = (id === 'Register') ? <Register app={this}/> : <Login app={this}/>;
                        this.setActive(component);
                        event.preventDefault();
                    }

                    render() {
                        const activeId = this.state.active.type.name;
                        let links = [];

                        for(const id of ['Login', 'Register']) {
                             if(activeId !== id) {
                  	             const searchLink = <div key={id}> <a href="#" onClick={this.clickHandler} id={id}>{id}</a> <br/> </div>;
                  	             links.push(searchLink);
                             }
                        }
                        return (
                            <div>
                                 {this.state.active}<br/>
                  	             {links}
                            </div>
                        );
                    }
                } // class App end




                const ws = new UserService();
                console.log("User Service Instantiated...!!!");
                ReactDOM.render(
                    <App ws={ws}/>,
                    document.getElementById('root')
                );


                })();  //end IIFE
        </script>
    </body>
</html>
